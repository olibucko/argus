<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Argus</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #09090b; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #18181b; }
        ::-webkit-scrollbar-thumb { background: #3f3f46; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #52525b; }
        .viewport-card.highlight { box-shadow: 0 0 12px 2px rgba(239, 68, 68, 0.6); border-color: #ef4444; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 12px 2px rgba(239, 68, 68, 0.6); } 50% { box-shadow: 0 0 18px 4px rgba(239, 68, 68, 0.8); } 100% { box-shadow: 0 0 12px 2px rgba(239, 68, 68, 0.6); } }
        input[type="date"]::-webkit-calendar-picker-indicator,
        input[type="time"]::-webkit-calendar-picker-indicator { filter: invert(0.8); }
        .fullscreen-enter-active, .fullscreen-leave-active { transition: opacity 0.3s ease; }
        .fullscreen-enter, .fullscreen-leave-to { opacity: 0; }
        .control-label { flex-shrink: 0; } /* Added for better alignment in settings modal */
        .main-border { border: 3px solid white; }
    </style>
</head>
<body class="bg-zinc-950 text-zinc-300 min-h-screen flex flex-col">
    {% raw %}
    <div id="app" class="flex flex-col flex-grow">
        <header class="sticky top-0 z-30 bg-zinc-950/80 backdrop-blur-sm border-b border-zinc-800/80 p-4 flex flex-col sm:flex-row sm:justify-between sm:items-center gap-4">
            <h1 class="text-xl font-bold text-white tracking-wider text-center sm:text-left">Argos</h1>
            <div class="flex items-center justify-center sm:justify-end space-x-4 sm:space-x-6">
                 <div class="flex items-center bg-zinc-900 border border-zinc-700 rounded-full px-3 py-2 text-sm font-medium">
                    <span class="mr-3" :class="{'text-green-400': isCurfewHours, 'text-amber-400': !isCurfewHours}">
                        <span class="hidden md:inline">{{ isCurfewHours ? 'Curfew: Active' : 'Curfew: Inactive' }}</span>
                    </span>
                    <span class="hidden lg:inline text-zinc-400">{{ formattedCurfewStart }} - {{ formattedCurfewEnd }}</span>
                    <button @click="showCurfewModal = true" class="ml-2 p-1 rounded-full text-zinc-400 hover:bg-zinc-700 hover:text-white transition-colors" aria-label="Edit Curfew">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                    </button>
                </div>
                <label class="flex items-center cursor-pointer">
                    <span class="mr-2 sm:mr-3 font-medium text-sm sm:text-base" :class="{'text-green-400': detectionEnabled, 'text-red-400': !detectionEnabled}">{{ detectionEnabled ? 'ON' : 'OFF' }}</span>
                    <div class="relative">
                        <input type="checkbox" class="sr-only" v-model="detectionEnabled" @change="toggleDetection">
                        <div class="block bg-zinc-800 w-14 h-8 rounded-full"></div>
                        <div class="dot absolute left-1 top-1 w-6 h-6 rounded-full transition-transform duration-300 ease-in-out" :class="{'translate-x-full bg-green-500': detectionEnabled, 'bg-red-500': !detectionEnabled}"></div>
                    </div>
                </label>
            </div>
        </header>

        <main class="flex flex-col lg:flex-row flex-grow p-4 md:p-6 gap-6">
            <section :class="gridClasses" class="gap-x-6 gap-y-2 lg:flex-grow auto-rows-min">
                <div v-for="(config, id) in viewportConfigs" :key="id" class="viewport-card bg-zinc-900 rounded-lg overflow-hidden  flex flex-col main-border transition-all duration-300 aspect-video" :class="{'highlight': activeViewports.includes(id)}">

                    <div class="flex-grow bg-black relative">

                        <div class="absolute top-0 left-0 w-full z-10 p-3 bg-zinc-950/50 backdrop-blur-sm flex justify-between items-center">
                            <h2 class="text-lg font-semibold text-zinc-100">{{ config.name }}</h2>
                            <div class="flex items-center gap-2">
                                <button @click="showSettings(id)" class="text-zinc-400 hover:text-white p-1 rounded-full hover:bg-zinc-700 transition-colors" aria-label="Open settings">
                                    <img src="/static/iconography/settings.svg" class="h-6 w-6" alt="Settings">
                                </button>
                                <button @click="enterFullscreen(id)" class="text-zinc-400 hover:text-white p-1 rounded-full hover:bg-zinc-700 transition-colors" aria-label="Enter fullscreen">
                                    <img src="/static/iconography/fullscreen.svg" class="h-6 w-6" alt="Fullscreen">
                                </button>
                            </div>
                        </div>

                        <img :src="`/video_feed/${id.split(',')[0]}/${id.split(',')[1]}`" class="w-full h-full object-cover absolute top-0 left-0" alt="Video Feed">
                    </div>
               
                </div>
            </section>
            
            <aside class="w-full lg:w-96 lg:flex-shrink-0 bg-zinc-900 rounded-lg main-border p-4 flex flex-col h-96 lg:h-auto">
                <h2 class="text-xl font-bold mb-4 text-zinc-100 flex items-center">Alert Log</h2>
                <div class="grid grid-cols-2 gap-x-2 gap-y-3 mb-6 text-sm">
                    <div>
                        <label class="block text-sm font-medium text-zinc-400">From Date</label>
                        <input type="date" v-model="filterFromDate" placeholder="All" class="w-full bg-zinc-800 border border-zinc-700 rounded px-2 py-1 text-zinc-200">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-zinc-400">From Time</label>
                        <input type="time" v-model="filterFromTime" placeholder="All" class="w-full bg-zinc-800 border border-zinc-700 rounded px-2 py-1 text-zinc-200">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-zinc-400">To Date</label>
                        <input type="date" v-model="filterToDate"  placeholder="All" class="w-full bg-zinc-800 border border-zinc-700 rounded px-2 py-1 text-zinc-200">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-zinc-400">To Time</label>
                        <input type="time" v-model="filterToTime" placeholder="All" class="w-full bg-zinc-800 border border-zinc-700 rounded px-2 py-1 text-zinc-200">
                    </div>
                </div>
                <div class="flex-grow overflow-y-auto space-y-3 pr-2">
                    <div v-if="alerts.length === 0" class="flex items-center justify-center h-full text-zinc-500"><p>No alerts recorded.</p></div>
                    <div v-else-if="filteredAlerts.length === 0" class="flex items-center justify-center h-full text-zinc-500"><p>No alerts match your filter.</p></div>
                    <div v-for="(alert, index) in paginatedAlerts" :key="index"
                         @click="alert.video_path && playVideo(alert.video_path)"
                         class="bg-zinc-800/50 p-3 rounded-lg border border-zinc-700/80 text-sm transition-colors"
                         :class="{'cursor-pointer hover:bg-zinc-700/60': alert.video_path}">
                        <div class="flex justify-between items-center mb-1"><p class="font-bold text-base text-red-400">{{ alert.viewport_name }}</p><p class="text-zinc-400 text-xs">{{ new Date(alert.timestamp).toLocaleString() }}</p>
                        </div>
                        <div class="flex justify-between items-center">
                            <p class="text-zinc-300">Confidence: <span class="font-medium">{{ alert.confidence }}%</span></p>
                            <span v-if="alert.video_path" class="text-xs font-bold text-indigo-400">VIDEO</span>
                        </div>
                    </div>
                </div>
                <div v-if="filteredAlerts.length > 0" class="mt-4 flex items-center justify-between border-t border-zinc-700 pt-3">
                    <button @click="previousPage" :disabled="currentPage === 1" class="px-3 py-1 rounded bg-zinc-700 hover:bg-zinc-600 text-white text-sm font-medium transition-colors disabled:opacity-50 disabled:cursor-not-allowed">Previous</button>
                    <span class="text-sm text-zinc-400">Page {{ currentPage }} of {{ totalPages }}</span>
                    <button @click="nextPage" :disabled="currentPage === totalPages" class="px-3 py-1 rounded bg-zinc-700 hover:bg-zinc-600 text-white text-sm font-medium transition-colors disabled:opacity-50 disabled:cursor-not-allowed">Next</button>
                </div>
            </aside>
        </main>

        <div v-if="settingsViewport" @click.self="closeSettings" class="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 p-4">
            <div class="bg-zinc-900 rounded-lg shadow-2xl border border-zinc-700 w-full max-w-lg">
                <div class="p-4 border-b border-zinc-700"><h2 class="text-xl font-bold text-white">Edit Settings: {{ currentSettings.name }}</h2></div>
                <div class="p-6 space-y-4 text-zinc-200">
                    <div class="flex items-center gap-4">
                        <label class="w-1/3 control-label font-medium text-zinc-400">Name</label>
                        <input type="text" v-model="currentSettings.name" class="w-2/3 bg-zinc-800 border border-zinc-700 rounded px-3 py-2">
                    </div>
                    <div class="flex items-center gap-4">
                        <label class="w-1/3 control-label font-medium text-zinc-400">Sensitivity</label>
                        <input type="range" v-model.number="currentSettings.sensitivity" min="0.1" max="1.0" step="0.05" class="w-2/3">
                        <span class="w-16 text-right">{{ currentSettings.sensitivity.toFixed(2) }}</span>
                    </div>
                    <div class="flex items-center gap-4">
                        <label class="w-1/3 control-label font-medium text-zinc-400">Min. Confidence</label>
                        <input type="range" v-model.number="currentSettings.min_confidence" min="0.1" max="1.0" step="0.05" class="w-2/3">
                        <span class="w-16 text-right">{{ currentSettings.min_confidence.toFixed(2) }}</span>
                    </div>
                </div>
                <div class="p-4 bg-zinc-950/50 border-t border-zinc-800 flex justify-end gap-3">
                    <button @click="closeSettings" class="px-4 py-2 rounded-md bg-zinc-700 hover:bg-zinc-600 text-white font-semibold transition-colors">Cancel</button>
                    <button @click="saveSettings" class="px-4 py-2 rounded-md bg-indigo-600 hover:bg-indigo-500 text-white font-semibold transition-colors">Save</button>
                </div>
            </div>
        </div>


        <transition name="fullscreen">
            <div v-if="fullscreenViewport" class="fixed inset-0 bg-black z-50 flex items-center justify-center">
                <img :src="fullscreenImageUrl" class="max-w-full max-h-full w-3/4 h-3/4 object-contain" alt="Fullscreen Viewport">
                <button @click="exitFullscreen" class="absolute top-5 right-5 text-white bg-black/50 p-2 rounded-full hover:bg-black/80 transition-colors" aria-label="Exit fullscreen">
                    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
        </transition>

        <div v-if="showVideoModal" @click.self="closeVideoModal" class="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 p-4 transition-opacity duration-300">
            <div class="bg-zinc-900 rounded-lg shadow-2xl border border-zinc-700 w-full max-w-4xl flex flex-col">
                <div class="flex justify-between items-center p-4 border-b border-zinc-700">
                    <h2 class="text-xl font-bold text-white">Video Playback</h2>
                    <button @click="closeVideoModal" class="text-zinc-400 hover:text-white transition-colors" aria-label="Close video player">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>
                <div class="p-2 sm:p-4 bg-black">
                    <video v-if="videoPlaybackUrl" :src="videoPlaybackUrl" class="w-full max-h-[80vh] object-contain" controls autoplay></video>
                </div>
            </div>
        </div>

        <div v-if="showCurfewModal" @click.self="showCurfewModal = false" class="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 p-4">
            <div class="bg-zinc-900 rounded-lg shadow-2xl border border-zinc-700 w-full max-w-sm">
                <div class="p-4 border-b border-zinc-700"><h2 class="text-xl font-bold text-white">Edit Curfew Times</h2></div>
                <div class="p-6 space-y-4">
                    <div><label class="block mb-1 font-medium text-zinc-400">Start Time</label><input type="time" v-model="newCurfewStart" class="w-full bg-zinc-800 border border-zinc-700 rounded px-3 py-2 text-zinc-200"></div>
                    <div><label class="block mb-1 font-medium text-zinc-400">End Time</label><input type="time" v-model="newCurfewEnd" class="w-full bg-zinc-800 border border-zinc-700 rounded px-3 py-2 text-zinc-200"></div>
                </div>
                <div class="p-4 bg-zinc-950/50 border-t border-zinc-800 flex justify-end gap-3">
                    <button @click="showCurfewModal = false" class="px-4 py-2 rounded-md bg-zinc-700 hover:bg-zinc-600 text-white font-semibold transition-colors">Cancel</button>
                    <button @click="updateCurfew" class="px-4 py-2 rounded-md bg-indigo-600 hover:bg-indigo-500 text-white font-semibold transition-colors">Save</button>
                </div>
            </div>
        </div>
    </div>
    {% endraw %}
    <script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.js"></script>
    <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
    <script>
        const socket = io();
        new Vue({
            el: '#app',
            data: {
                detectionEnabled: false,
                isCurfewHours: false,
                formattedCurfewStart: '00:00',
                formattedCurfewEnd: '00:00',
                showCurfewModal: false,
                newCurfewStart: '00:00',
                newCurfewEnd: '00:00',
                alerts: [],
                viewportConfigs: {},
                gridSize: [2, 2],
                activeViewports: [],
                fullscreenViewport: null, // Tracks the active fullscreen viewport
                showVideoModal: false,
                videoPlaybackUrl: '',
                settingsViewport: null, // Tracks which viewport's settings are open
                currentSettings: {}, // Holds the settings for the active modal
                filterFromDate: '',
                filterFromTime: '',
                filterToDate: '',
                filterToTime: '',
                highlightTimeouts: {}, // Tracks viewport highlight timeouts
                cooldownPeriod: 30, // Default cooldown period in seconds
                currentPage: 1,
                itemsPerPage: 10
            },
            computed: {
                fullscreenImageUrl() {
                    if (!this.fullscreenViewport) return '';
                    const [row, col] = this.fullscreenViewport.split(',');
                    return `/video_feed/${row}/${col}`;
                },
                filteredAlerts() {
                    if (!this.filterFromDate && !this.filterFromTime && !this.filterToDate && !this.filterToTime) {
                        return this.alerts;
                    }

                    return this.alerts.filter(alert => {
                        const alertDate = new Date(alert.timestamp);

                        let fromDateTime = null;
                        if (this.filterFromDate || this.filterFromTime) {
                            const fromDateStr = this.filterFromDate || alertDate.toISOString().substring(0, 10);
                            const fromTimeStr = this.filterFromTime || '00:00';
                            // Construct date as local time by splitting and re-assembling
                            const [y, M, d] = fromDateStr.split('-').map(Number);
                            const [h, m] = fromTimeStr.split(':').map(Number);
                            fromDateTime = new Date(y, M - 1, d, h, m, 0);
                        }

                        let toDateTime = null;
                        if (this.filterToDate || this.filterToTime) {
                            const toDateStr = this.filterToDate || alertDate.toISOString().substring(0, 10);
                            const toTimeStr = this.filterToTime || '23:59';
                            const [y, M, d] = toDateStr.split('-').map(Number);
                            const [h, m] = toTimeStr.split(':').map(Number);
                            toDateTime = new Date(y, M - 1, d, h, m, 59); // Use 59 seconds to include the full minute
                        }

                        if (fromDateTime && alertDate < fromDateTime) {
                            return false;
                        }
                        if (toDateTime && alertDate > toDateTime) {
                            return false;
                        }

                        return true;
                    });
                },
                paginatedAlerts() {
                    const start = (this.currentPage - 1) * this.itemsPerPage;
                    const end = start + this.itemsPerPage;
                    return this.filteredAlerts.slice(start, end);
                },
                totalPages() {
                    return Math.ceil(this.filteredAlerts.length / this.itemsPerPage);
                },
                gridClasses() {
                    const [rows, cols] = this.gridSize;
                    let classes = 'grid ';

                    // Handle different grid sizes with responsive design
                    if (cols === 1) {
                        classes += 'grid-cols-1';
                    } else if (cols === 2) {
                        classes += 'grid-cols-1 md:grid-cols-2';
                    } else if (cols === 3) {
                        classes += 'grid-cols-1 md:grid-cols-2 lg:grid-cols-3';
                    } else if (cols === 4) {
                        classes += 'grid-cols-1 md:grid-cols-2 lg:grid-cols-4';
                    } else {
                        // For more than 4 columns, use responsive scaling
                        classes += 'grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4';
                    }

                    return classes;
                },
            },
            methods: {
                
                handleKeydown(event) {
                    if (event.key === 'Escape') {
                        if (this.fullscreenViewport) this.exitFullscreen();
                        if (this.showVideoModal) this.closeVideoModal();
                        if (this.showCurfewModal) this.showCurfewModal = false;
                    }
                },

                enterFullscreen(id) {
                    this.fullscreenViewport = id;
                },

                exitFullscreen() {
                    this.fullscreenViewport = null;
                },

                addAlert(alertData) {
                    this.alerts.unshift(alertData);
                    if (this.alerts.length > 100) this.alerts.pop();
                },

                triggerViewportHighlight(data) {
                    const viewportId = `${data.row},${data.col}`;

                    // Clear existing timeout if viewport is already highlighted
                    if (this.highlightTimeouts && this.highlightTimeouts[viewportId]) {
                        clearTimeout(this.highlightTimeouts[viewportId]);
                    }

                    // Add to active viewports if not already there
                    if (!this.activeViewports.includes(viewportId)) {
                        this.activeViewports.push(viewportId);
                    }

                    // Set new timeout to remove highlight (short timeout, resets on each detection)
                    if (!this.highlightTimeouts) this.highlightTimeouts = {};
                    const highlightDuration = 7000; // 7 seconds - clears quickly after last detection
                    this.highlightTimeouts[viewportId] = setTimeout(() => {
                        const index = this.activeViewports.indexOf(viewportId);
                        if (index > -1) this.activeViewports.splice(index, 1);
                        delete this.highlightTimeouts[viewportId];
                    }, highlightDuration);
                },

                fetchViewportConfigs() {
                    // Viewport configs are now received via socketio on connect
                    // This method is kept for compatibility but configs are loaded dynamically
                    for (const id in this.viewportConfigs) {
                        const [row, col] = id.split(',');
                        fetch(`/viewport_config/${row}/${col}`)
                            .then(response => response.json())
                            .then(data => { if (!data.error) this.$set(this.viewportConfigs, id, data); })
                            .catch(error => console.error(`Error fetching config for viewport ${id}:`, error));
                    }
                },

                fetchEventHistory() {
                    fetch('/api/events')
                        .then(response => response.json())
                        .then(data => { this.alerts = data; })
                        .catch(error => console.error('Error fetching event history:', error));
                },

                updateCurfewStatus(startStr, endStr) {
                    const wasCurfewHours = this.isCurfewHours; // Remember the state before the check
                    const now = new Date();
                    const currentTimeInMinutes = now.getHours() * 60 + now.getMinutes();
                    const [startHour, startMinute] = startStr.split(':').map(Number);
                    const [endHour, endMinute] = endStr.split(':').map(Number);
                    const startTimeInMinutes = startHour * 60 + startMinute;
                    const endTimeInMinutes = endHour * 60 + endMinute;
                    
                    if (startTimeInMinutes <= endTimeInMinutes) {
                        this.isCurfewHours = currentTimeInMinutes >= startTimeInMinutes && currentTimeInMinutes <= endTimeInMinutes;
                    } else { // Curfew crosses midnight
                        this.isCurfewHours = currentTimeInMinutes >= startTimeInMinutes || currentTimeInMinutes <= endTimeInMinutes;
                    }

                    // Logic to auto-enable or auto-disable detection ---
                    if (this.isCurfewHours && !wasCurfewHours) {
                        // Curfew just became active. Turn detection ON if it's off.
                        if (!this.detectionEnabled) {
                            this.detectionEnabled = true;
                            this.toggleDetection();
                        }
                    } else if (!this.isCurfewHours && wasCurfewHours) {
                        // Curfew just ended. Turn detection OFF if it's on.
                        if (this.detectionEnabled) {
                            this.detectionEnabled = false;
                            this.toggleDetection();
                        }
                    }
                },

                playVideo(path) {
                    if (!path) return;
                    const filename = path.replace(/\\/g, '/').split('/').pop();
                    this.videoPlaybackUrl = `/event_videos/${filename}`;
                    this.showVideoModal = true;
                },

                toggleDetection() {
                    socket.emit('set_detection_state', { enabled: this.detectionEnabled });
                },

                updateCurfew() {
                    socket.emit('update_curfew_times', {
                        start: this.newCurfewStart,
                        end: this.newCurfewEnd
                    });
                    this.showCurfewModal = false;
                },

                closeVideoModal() {
                    this.showVideoModal = false;
                    this.videoPlaybackUrl = ''; 
                },

                showSettings(id) {
                this.settingsViewport = id;
                // Create a copy of the config to avoid modifying the original until saved
                this.currentSettings = JSON.parse(JSON.stringify(this.viewportConfigs[id]));
                },

                closeSettings() {
                    this.settingsViewport = null;
                    this.currentSettings = {};
                },

                saveSettings() {
                    const [row, col] = this.settingsViewport.split(',');
                    socket.emit('update_viewport_config', {
                        row: parseInt(row),
                        col: parseInt(col),
                        config: this.currentSettings
                    });
                    this.closeSettings();
                },

                previousPage() {
                    if (this.currentPage > 1) {
                        this.currentPage--;
                    }
                },

                nextPage() {
                    if (this.currentPage < this.totalPages) {
                        this.currentPage++;
                    }
                },
            },
            watch: {
                filterFromDate() { this.currentPage = 1; },
                filterFromTime() { this.currentPage = 1; },
                filterToDate() { this.currentPage = 1; },
                filterToTime() { this.currentPage = 1; },
            },
            mounted() {
                this.fetchViewportConfigs();
                this.fetchEventHistory();
                window.addEventListener('keydown', this.handleKeydown);
                
                socket.on('connect', () => {
                    console.log('Socket.IO connected!');
                });

                socket.on('detection_state_update', data => {
                    this.detectionEnabled = data.enabled;
                });
                
                socket.on('curfew_times', data => {
                    this.formattedCurfewStart = data.start;
                    this.formattedCurfewEnd = data.end;
                    this.newCurfewStart = data.start;
                    this.newCurfewEnd = data.end;
                    if (data.cooldown_period !== undefined) {
                        this.cooldownPeriod = data.cooldown_period;
                    }
                    this.updateCurfewStatus(data.start, data.end);
                });

                socket.on('curfew_times_updated', data => {
                    this.formattedCurfewStart = data.start;
                    this.formattedCurfewEnd = data.end;
                    this.updateCurfewStatus(data.start, data.end); // Recalculate status immediately
                });
                    
                socket.on('detection_in_progress', data => {
                    this.triggerViewportHighlight(data);
                });

                socket.on('new_alert', data => { 
                    this.addAlert(data);
                    this.triggerViewportHighlight(data);
                });
                
                setInterval(() => {
                    this.updateCurfewStatus(this.formattedCurfewStart, this.formattedCurfewEnd);
                }, 30000);

                socket.on('viewport_config_updated', data => {
                    const id = `${data.row},${data.col}`;
                    this.$set(this.viewportConfigs, id, data.config);
                });

                socket.on('viewport_configs', data => {
                    this.viewportConfigs = data.configs;
                    this.gridSize = data.grid_size;
                    console.log('Received dynamic viewport configs:', data);
                });
            },
            beforeDestroy() {
                window.removeEventListener('keydown', this.handleKeydown);
            }
        });
    </script>
</body>
</html>